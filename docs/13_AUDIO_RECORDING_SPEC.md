# 13 AUDIO RECORDING SPEC

이 문서는 TinyWords의 음성 녹음 기능 스펙 SSOT이다.  
목표는 사용자가 문장을 실제로 발화하도록 돕고, 녹음 데이터를 안전하게 로컬에 저장하여 학습 루틴(회상-문장-발화)을 완성하는 것이다.

---

## 1) 기능 목적

- 사용자가 학습 문장을 소리 내어 말하게 유도한다.
- 발화 시도 기록을 남겨 반복 학습과 자기 피드백을 지원한다.
- 녹음 실패/권한 거부 상황에서도 학습 흐름이 중단되지 않게 한다.

---

## 2) 범위

### MVP 포함

- 마이크 권한 요청/확인
- 녹음 시작/일시정지(선택)/중지
- 로컬 오디오 파일 저장(`audio_uri`)
- 녹음 재생/재녹음/삭제
- `SpeechAttempt` 메타데이터 저장(`duration_ms`, `created_at`)

### MVP 제외(후속)

- 서버 업로드/동기화
- 고급 잡음 제거/실시간 ASR 자막
- 음소 단위 정밀 피드백

---

## 3) 사용자 플로우

1. 사용자가 학습 단계에서 `녹음 시작` 탭
2. 권한 상태 확인
   - 허용: 녹음 진행
   - 미허용: 권한 안내 + 설정 이동 CTA
3. 사용자 발화 후 `중지`
4. 로컬 파일 저장 및 재생 가능한 상태 표시
5. 사용자가 `저장` 또는 `재녹음` 선택
6. 저장 시 `SpeechAttempt` 생성

완료 기준:
- 최소 1회 녹음 저장 또는 정책상 허용된 `skipped` 처리

---

## 4) 권한 정책

- 권한 타입: 마이크
- 권한 상태:
  - `granted`
  - `denied`
  - `restricted` (시스템 제약)
  - `unknown` (초기/조회 실패)

동작 규칙:
- `denied/restricted`에서는 녹음 시작 불가
- 권한이 없어도 텍스트 학습(회상/문장)은 계속 가능
- 권한 요청은 사용자 액션(녹음 버튼 탭) 기반으로만 수행

---

## 5) UI/상태 스펙

### 5.1 녹음 컨트롤

- 기본 버튼: `녹음 시작`
- 녹음 중: `중지` (선택: `일시정지/재개`)
- 녹음 완료: `재생`, `재녹음`, `저장`

### 5.2 상태 머신

- `idle`: 녹음 전
- `requesting_permission`: 권한 요청 중
- `recording`: 녹음 중
- `recorded_preview`: 녹음 완료, 저장 전 미리듣기
- `saving`: 파일/메타 저장 중
- `saved`: 저장 완료
- `error`: 오류 상태

전이:
- `idle -> recording` (권한 허용 시)
- `recording -> recorded_preview` (중지)
- `recorded_preview -> saving -> saved`
- 어느 상태에서든 오류 발생 시 `error`

---

## 6) 오디오 파일 정책

- 저장 위치: 앱 로컬 sandbox 디렉토리
- 파일 포맷(권장): `m4a` (AAC)
- 파일 네이밍(예시):
  - `{user_id}/{plan_item_id}/{speech_id}.m4a`
- 저장 시점:
  - 사용자가 `저장` 확정했을 때만 영구 보관
- 임시 파일:
  - 미저장 녹음은 세션 종료/취소 시 삭제

보존 정책(MVP 권장):
- 최근 90일 또는 최근 N개(예: 300개) 보관
- 초과 시 오래된 항목부터 정리(사용자 안내 포함)

---

## 7) 데이터 모델 매핑

`04_DATA_MODEL.md` `SpeechAttempt` 매핑:

- `speech_id`: UUID
- `plan_item_id`: 현재 학습 항목 FK
- `audio_uri`: 로컬 파일 경로
- `duration_ms`: 녹음 길이
- `pronunciation_score`: 초기에는 null 허용
- `scoring_version`: 점수 산출 시 기록
- `created_at`: 저장 시각

저장 제약:
- `audio_uri`는 반드시 로컬 경로여야 함
- 파일 실체와 DB 레코드 불일치 시 복구 루틴 실행

---

## 8) 인터랙션 규칙

- 녹음 중 화면 이탈:
  - 자동 중지 후 임시 저장 여부 확인 다이얼로그
- 재녹음:
  - 기존 미리듣기 파일 폐기 후 새 녹음으로 교체
- 삭제:
  - 파일 삭제 + 해당 `SpeechAttempt` 소프트 삭제 또는 비활성 처리
- 저장 완료 후:
  - PlanItem 발화 단계 상태를 `done`으로 갱신

---

## 9) 오류/예외 처리

### 9.1 권한 거부

- 메시지: "마이크 권한이 필요해요. 설정에서 허용해 주세요."
- 버튼: `시스템 설정 열기`, `나중에`
- 대체 흐름: 발화 단계 `skipped` 허용(정책 범위 내)

### 9.2 녹음 장치 오류

- 상황: 마이크 점유, 장치 없음, 인코더 실패
- 처리: 오류 메시지 + 재시도 버튼 + 로그 기록

### 9.3 저장 실패(디스크 부족/IO 오류)

- 메시지: "녹음을 저장하지 못했어요."
- 처리: 재시도/재녹음 선택지 제공
- 부분 저장 금지(원자적 저장 원칙)

### 9.4 파일-DB 불일치

- 앱 시작/화면 진입 시 무결성 체크
- 파일 없음 + DB 있음: 레코드 복구 불가 상태 표기 및 정리
- 파일 있음 + DB 없음: 고아 파일 정리 큐로 이동

---

## 10) 성능/품질 기준

- 녹음 시작 지연: 사용자 탭 후 300ms 이내 목표
- 저장 완료 피드백: 중지 후 1초 이내(일반 환경)
- 재생 시작 지연: 300ms 이내 목표
- 실패율 모니터링:
  - 권한 오류율
  - 저장 실패율
  - 재생 실패율

---

## 11) 보안/개인정보

- 기본 저장은 기기 로컬만 허용
- 사용자 명시적 동의 없이 외부 전송 금지
- 로그에는 원본 오디오 경로/내용 직접 노출 최소화
- 디버그 로그에 민감정보 마스킹 적용

추가 원칙:
- AI API 키는 클라이언트 저장 금지
- 발음 점수 산출 시 서버 호출이 필요하면 최소 데이터만 전송

---

## 12) 접근성/UX 가이드

- 녹음 상태를 색상 + 텍스트 + 아이콘으로 동시 표시
- 녹음 중 타이머를 제공해 진행 인지 보장
- 진동/소리 피드백은 사용자 설정으로 제어 가능
- 권한 거부 문구는 비난형 표현 금지

---

## 13) 분석 이벤트

- `recording_started`
  - props: `plan_item_id`, `permission_state`
- `recording_stopped`
  - props: `duration_ms`
- `recording_saved`
  - props: `speech_id`, `duration_ms`
- `recording_deleted`
  - props: `speech_id`, `reason(user|replace|cleanup)`
- `recording_error`
  - props: `error_type(permission|device|io|unknown)`

---

## 14) 테스트 기준(요약)

필수 테스트:
1. 권한 허용/거부/제한 상태별 동작 검증
2. 녹음-저장-재생-삭제 전체 플로우 검증
3. 앱 강제 종료 후 저장된 녹음 복원 검증
4. 디스크 부족/IO 오류 시 예외 처리 검증
5. 파일-DB 무결성 복구 로직 검증

상세 케이스는 `19_TEST_PLAN.md`에서 관리한다.

---

## 15) 수용 기준(DoD)

1. 사용자는 권한 허용 시 녹음을 시작/중지/저장할 수 있다.
2. 저장된 녹음은 로컬 파일과 `SpeechAttempt` 레코드가 일치한다.
3. 권한 거부/저장 실패 상황에서도 학습 흐름이 완전히 중단되지 않는다.
4. 저장된 녹음은 재생/재녹음/삭제가 가능하다.
5. 개인정보/보안 원칙(로컬 저장, 무단 전송 금지)을 준수한다.

---

## 16) 관련 문서

- 발음 점수 스펙: `14_PRONUNCIATION_SCORING_SPEC.md`
- 데이터 모델: `04_DATA_MODEL.md`
- Today 스펙: `05_SCREEN_SPEC_TODAY.md`
- Settings 스펙: `08_SCREEN_SPEC_SETTINGS.md`
- 보안/개인정보: `16_SECURITY_PRIVACY_KEYS.md`
- 테스트 계획: `19_TEST_PLAN.md`
