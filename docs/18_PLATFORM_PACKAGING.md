# 18 PLATFORM PACKAGING

이 문서는 TinyWords의 멀티플랫폼 패키징/배포 전략 SSOT이다.  
핵심 전략은 **단일 코드베이스(웹 기반) + 네이티브 패키징**으로 개발 효율과 배포 일관성을 동시에 확보하는 것이다.

---

## 1) 플랫폼 전략 요약

- 1차 대상: `iOS`, `iPadOS`, `Android`
- 보조 대상: `macOS`(우선 iPad 앱 실행 전략)
- 코드 전략: 프론트엔드 단일 코드베이스 우선
- 패키징 전략: 플랫폼별 네이티브 컨테이너를 통한 스토어 배포

---

## 2) 목표/비목표

### 목표

- 핵심 학습 루프(Today/Inbox/History/Settings)를 모든 1차 플랫폼에서 동일하게 제공
- 오디오 녹음/권한 동작을 플랫폼 정책에 맞게 안정화
- 릴리즈 주기와 품질 기준을 플랫폼 간 통일

### 비목표(MVP)

- 플랫폼별 완전 분리 네이티브 코드베이스 운영
- 데스크톱 전용 UI 별도 구현
- 플랫폼마다 기능 스펙 차등 운영

---

## 3) 대상 플랫폼별 방침

### 3.1 iOS / iPadOS

- 배포: App Store
- 우선 패키징: iOS 네이티브 웹 컨테이너(예: Capacitor 계열)
- 필수 권한:
  - 마이크(녹음 기능)
  - 알림(선택)

### 3.2 Android

- 배포: Google Play
- 패키징: Android 네이티브 웹 컨테이너
- 필수 권한:
  - RECORD_AUDIO
  - POST_NOTIFICATIONS(버전/정책 기준에 따라)

### 3.3 macOS

- 1차: iPad 앱 실행 전략 우선
- 2차(필요 시): 데스크톱 전용 타깃(Electron 계열) 검토

---

## 4) 아키텍처 원칙

- UI/도메인 로직은 공통 레이어에 유지
- 플랫폼 특화 코드는 "권한/파일/알림/오디오" 브릿지로 최소화
- API 계약/데이터 모델은 플랫폼 공통 준수
- 오프라인 우선 정책(로컬 저장)을 동일하게 유지

---

## 5) 패키징 산출물

- iOS: `ipa` (store archive)
- Android: `aab` (Google Play 기본)
- 내부 테스트:
  - iOS TestFlight 빌드
  - Android internal track 빌드

버전 필드:
- 마케팅 버전: `MAJOR.MINOR.PATCH`
- 빌드 번호: 플랫폼별 증가값 분리 관리

---

## 6) 환경/설정 분리

- 환경 구분:
  - `dev`
  - `staging`
  - `prod`
- 분리 대상:
  - API base URL
  - 기능 플래그
  - 분석 키(민감정보 제외)

원칙:
- 프로덕션 비밀키는 클라이언트에 포함 금지
- 환경 변수 주입은 CI/CD에서 수행

---

## 7) 권한/스토어 정책 체크

필수 체크:
- 권한 요청 시점은 사용자 액션 기반
- 권한 미허용 시 대체 흐름 제공(학습 중단 금지)
- 권한 설명 문구(스토어/앱 내)가 실제 기능과 일치

플랫폼 공통 원칙:
- 최소 권한 요청
- 불필요 권한 제거

---

## 8) 오디오/파일 시스템 패키징 고려사항

- 오디오 저장 경로는 앱 sandbox 고정
- 임시 파일 정리 정책 포함
- 백그라운드/포그라운드 전환 시 녹음 상태 복원 규칙 일관화
- 플랫폼별 오디오 세션 충돌 처리(전화/다른 앱 재생) 정의

---

## 9) 업데이트 정책

- 스토어 업데이트 주기: 2주 또는 월간 배치(팀 상황에 맞춤)
- 핫픽스 기준:
  - 학습 진행 불가 버그
  - 데이터 손실/보안 위험
- 강제 업데이트는 보안/호환성 임계 상황에서만 사용

마이그레이션:
- 앱 업데이트 시 로컬 DB 스키마 마이그레이션 자동 수행
- 실패 시 안전 롤백 또는 복구 가이드 노출

---

## 10) 릴리즈 파이프라인(요약)

1. 코드/문서 동결(Release branch)
2. 플랫폼별 빌드 생성
3. 자동 테스트 + 수동 스모크 테스트
4. 스토어 메타데이터/스크린샷 갱신
5. 내부 배포(TestFlight/Internal track)
6. 최종 승인 후 프로덕션 출시
7. 출시 후 모니터링(크래시/성능/핵심 KPI)

---

## 11) CI/CD 권장 구성

- 공통:
  - lint, type-check, unit/integration test
  - 빌드 산출물 생성
- 플랫폼 단계:
  - iOS signing, archive, upload
  - Android signing, bundle, upload
- 보안:
  - 서명키/비밀값은 CI secret vault에서 주입
  - 로그에 민감값 출력 차단

---

## 12) 품질 게이트(출시 차단 조건)

아래 중 하나라도 실패하면 출시 차단:

- 핵심 플로우(Today/Inbox) 진행 불가
- 데이터 유실/복원 실패 재현
- 크래시율 임계치 초과
- 권한 거부 시 대체 흐름 미동작
- 보안 정책 위반(키 노출, 민감 로그)

---

## 13) 플랫폼별 테스트 매트릭스

### 최소 디바이스/OS 조합(예시)

- iOS: 최신-1, 최신
- iPadOS: 최신
- Android: API LTS 범위 내 2개 이상 버전

### 필수 시나리오

- 첫 설치 -> 온보딩 -> Today 완료
- Inbox overdue 처리
- 오디오 녹음 권한 허용/거부
- 오프라인 학습 후 재실행 복원
- 앱 업데이트 후 데이터 마이그레이션

---

## 14) 스토어 메타/컴플라이언스

- 스토어 설명에 핵심 기능/권한 사용 목적 명시
- 개인정보 처리방침 URL 최신화
- 연령 등급/콘텐츠 정책 준수
- 수출 규정/암호화 관련 문항 확인(스토어 요구사항 기준)

---

## 15) 장애 대응/롤백 전략

- 앱 릴리즈 후 이상 징후 시:
  1. 배포 중단
  2. 원인 버전 식별
  3. 서버 플래그로 위험 기능 제한(가능 시)
  4. 핫픽스 빌드 제출
- 스토어 롤백이 어려운 경우:
  - 기능 플래그 + 긴급 업데이트 조합으로 완화

---

## 16) 수용 기준(DoD)

1. iOS/iPadOS/Android에서 동일한 핵심 학습 루프가 동작한다.
2. 오디오 권한/저장/재생 흐름이 플랫폼별 정책에 맞게 동작한다.
3. 패키징 산출물(ipa/aab)이 CI에서 재현 가능하게 생성된다.
4. 보안/개인정보 정책(키 비노출, 민감 로그 차단)을 충족한다.
5. 릴리즈 게이트를 통과한 빌드만 스토어 배포된다.

---

## 17) 관련 문서

- 보안/개인정보: `16_SECURITY_PRIVACY_KEYS.md`
- API 계약: `15_API_CONTRACT.md`
- 오디오 녹음: `13_AUDIO_RECORDING_SPEC.md`
- 발음 점수: `14_PRONUNCIATION_SCORING_SPEC.md`
- 테스트 계획: `19_TEST_PLAN.md`
- 릴리즈 체크리스트: `20_RELEASE_CHECKLIST.md`
