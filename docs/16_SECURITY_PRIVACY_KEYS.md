# 16 SECURITY PRIVACY KEYS

이 문서는 TinyWords의 보안/개인정보/키 관리 정책 SSOT이다.  
목표는 학습 데이터를 안전하게 보호하면서도 오프라인 우선 경험을 유지하고, AI/음성 기능에서 민감 정보가 유출되지 않도록 하는 것이다.

---

## 1) 보안 원칙

- **최소 권한(Least Privilege):** 필요한 권한만 요청하고 최소 범위로 사용한다.
- **기본 비공개(Privacy by Default):** 사용자 동의 없는 외부 전송 금지.
- **클라이언트 비밀정보 금지:** API 키/시크릿은 앱 번들/코드에 포함하지 않는다.
- **로컬 우선 저장:** 학습 기록/오디오는 기기 내 저장을 기본으로 한다.
- **감사 가능성:** 핵심 보안 이벤트는 추적 가능한 형태로 기록한다.

---

## 2) 데이터 분류

### 2.1 Public

- 앱 버전, 비민감 설정 메타 등

### 2.2 Internal

- 학습 상태(`DayPlan`, `PlanItem`, `ReviewTask`)
- 이벤트 로그(비식별)

### 2.3 Sensitive

- 사용자 작성 문장(`sentence_en`)
- 오디오 파일(`audio_uri`가 가리키는 원본)
- 인증 토큰/세션 정보

처리 원칙:
- Sensitive 데이터는 저장/전송/로그에서 강화 정책 적용

---

## 3) 키/시크릿 관리

### 3.1 금지 사항

- AI API 키를 클라이언트 코드/번들/.env(배포물)에 포함 금지
- Git 저장소에 키/토큰 커밋 금지
- 로그에 키/토큰 평문 출력 금지

### 3.2 저장 위치

- 서버 환경변수 또는 비밀관리 시스템(Secrets Manager)
- 접근 권한은 서비스 계정 단위 최소화

### 3.3 운영 규칙

- 키는 분기별 회전(rotation) 권장
- 유출 의심 시 즉시 폐기/재발급
- 키 사용량 모니터링 및 비정상 패턴 알림 설정

---

## 4) 인증/세션 정책

- 인증 방식: Bearer 토큰 기반(서버 검증)
- 토큰 저장:
  - 모바일: OS 보안 저장소(Keychain/Keystore) 우선
  - 웹: HttpOnly Secure 쿠키 우선(가능 시)
- 토큰 만료:
  - 짧은 access token + 갱신 토큰 전략 권장
- 로그아웃 시:
  - 로컬 토큰 즉시 파기
  - 서버 세션 무효화(지원 시)

---

## 5) 전송 구간 보호

- 모든 API 통신은 TLS(HTTPS) 필수
- 평문 HTTP 요청 차단
- 인증/민감 API는 HSTS 적용 권장
- 인증서 오류 시 연결 중단(우회 허용 금지)

---

## 6) 저장 구간 보호

### 6.1 로컬 DB

- 학습 데이터는 앱 sandbox 내부 저장
- 가능하면 디바이스 암호화 스토리지 사용
- 디버그 빌드에서도 민감 테이블 덤프 노출 최소화

### 6.2 오디오 파일

- 저장 위치: 앱 sandbox
- 기본 외부 업로드 금지
- 사용자 삭제 요청 시 파일/메타 동시 정리

### 6.3 서버 저장

- 최소 보존 원칙(필요한 기간만 저장)
- 백업 데이터에도 동일 접근통제/암호화 정책 적용

---

## 7) 로그/분석 데이터 정책

- 절대 로그 금지:
  - API 키/토큰/Authorization 헤더 원문
  - 오디오 원본/바이너리
  - 사용자 문장 원문 전체(가능하면 해시/요약)
- 허용 로그 예:
  - `request_id`, `endpoint`, `status_code`, `latency_ms`
  - 에러 코드/필드명(값 마스킹)

마스킹 규칙:
- 토큰: 앞 4자 + 뒤 2자만 남기고 마스킹
- 경로/URI: 사용자 식별 조각 제거 또는 해시화

---

## 8) AI/음성 기능 개인정보 규칙

- AI 요청에는 최소 필드만 전송(데이터 최소화)
- 오디오 점수 산출 시 원본 오디오의 외부 전송 범위를 명시적으로 관리
- 프롬프트/응답 로깅은 샘플링 + 비식별 처리
- AI 실패 시 재시도 로그에 민감 본문 포함 금지

---

## 9) 접근 제어(RBAC) 권장

- 운영자 역할 최소 분리:
  - `viewer`: 지표/로그 조회
  - `operator`: 배포/설정 변경
  - `security_admin`: 키/권한 관리
- 프로덕션 DB 직접 조회는 승인 기반, 시간 제한 세션 사용

---

## 10) 데이터 보존/삭제 정책

### 10.1 보존

- 학습 이력: 서비스 운영 필요 범위 내 보존
- 오디오: 기본 로컬 보존, 서버 저장 시 기간 제한 명시

### 10.2 삭제

- 사용자 초기화/삭제 요청 시:
  - 로컬: 즉시 삭제
  - 서버: 규정 기간 내 삭제 완료 및 상태 기록

### 10.3 백업

- 백업 복원 테스트 정기 수행
- 삭제 요청 데이터가 백업에서 영구 보존되지 않도록 만료 정책 적용

---

## 11) 위협 모델(요약)

주요 위협과 대응:

1. **클라이언트 키 유출**
   - 대응: 키 클라이언트 저장 금지, 서버 프록시 호출
2. **로그 기반 민감정보 유출**
   - 대응: 로그 마스킹/필드 allowlist
3. **오디오 무단 전송**
   - 대응: 업로드 기본 비활성 + 명시 동의 플로우
4. **재전송/중복 요청 악용**
   - 대응: `X-Request-Id` 멱등 처리, rate limit
5. **권한 오남용**
   - 대응: RBAC + 접근 감사 로그

---

## 12) 보안 이벤트/모니터링

필수 모니터링 지표:
- 인증 실패율, 비정상 로그인 시도
- 4xx/5xx 비율 급증
- AI 호출량 급증/비정상 패턴
- 키 사용량 이상 탐지

보안 이벤트 예시:
- `auth_failed`
- `token_revoked`
- `secret_rotated`
- `suspicious_api_burst`
- `sensitive_log_blocked`

---

## 13) 사고 대응(Incident Response)

### 13.1 트리거

- 키 유출 의심
- 데이터 유출 정황
- 비정상 대량 호출/과금 폭증

### 13.2 즉시 조치

1. 영향 범위 식별
2. 노출 키/토큰 폐기 및 재발급
3. 의심 트래픽 차단(rate limit/IP 차단)
4. 임시 완화(취약 엔드포인트 제한)

### 13.3 사후 조치

- 원인 분석(RCA) 문서화
- 재발 방지 액션(코드/설정/운영 프로세스) 반영
- 필요 시 사용자 공지/정책 업데이트

---

## 14) 컴플라이언스/사용자 권리(요약)

- 개인정보 처리 목적/범위를 사용자에게 명확히 안내
- 동의 철회/데이터 삭제 요청 경로 제공
- 지역 법규(예: GDPR/CCPA 유사 요구사항) 적용 시 정책 확장

---

## 15) 구현 체크리스트

- [ ] 클라이언트 코드에 비밀키 없음
- [ ] 모든 민감 API HTTPS 강제
- [ ] 로그 마스킹 규칙 적용/테스트 완료
- [ ] 오디오/문장 원문 로그 차단
- [ ] 키 회전 절차 문서화
- [ ] 사고 대응 런북 준비

---

## 16) 테스트 기준(요약)

1. 키/토큰 로그 노출 차단 테스트
2. HTTPS 미사용 요청 차단 테스트
3. 권한 없는 요청(401/403) 처리 테스트
4. 삭제 요청 시 로컬/서버 데이터 정리 테스트
5. 멱등 키 중복 요청 악용 방지 테스트

상세는 `19_TEST_PLAN.md`에서 관리한다.

---

## 17) 관련 문서

- API 계약: `15_API_CONTRACT.md`
- 오디오 녹음: `13_AUDIO_RECORDING_SPEC.md`
- 발음 점수: `14_PRONUNCIATION_SCORING_SPEC.md`
- 단어 생성 프롬프트: `09_AI_WORD_GENERATION_PROMPT.md`
- 문장 코칭 프롬프트: `10_AI_SENTENCE_COACH_PROMPT.md`
- 플랫폼 패키징: `18_PLATFORM_PACKAGING.md`
- 릴리즈 체크리스트: `20_RELEASE_CHECKLIST.md`
